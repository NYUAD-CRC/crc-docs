

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Singularity Overlays &mdash; CRC Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="R in HPC Miniconda" href="r_hpc_miniconda.html" />
    <link rel="prev" title="Singularity - How to Run on HPC" href="singularity_commands.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/crc-wordmark-light.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">HPC Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hpc.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dalma.html">Dalma HPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounts/index.html">Accounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/index.html">System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage/index.html">Storage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Software</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#software-modules-and-environment">Software Modules and environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#hpc-miniconda">HPC Miniconda</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#matlab">Matlab</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#singularity">Singularity</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="singularity.html">Singularity Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="singularity_commands.html">Singularity - How to Run on HPC</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Singularity Overlays</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-an-overlay">Creating an Overlay</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-container-with-overlay-filesystem">Run container with overlay filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-to-overlay-filesystem">Write to overlay filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#while-in-container">While in container</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sharing-the-overlay">Sharing the Overlay</a></li>
<li class="toctree-l4"><a class="reference internal" href="#job-submission">Job Submission</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/index.html">Jobs Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ood/index.html">HPC Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../research/index.html">Research Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help/index.html">Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/index.html">HPC Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_load/index.html">HPC Load</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RCS Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rcs/rcs.html">Research Computing Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rcs/1001n.html">1001n Research Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rcs/kb/index.html">Knowledge Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rcs/data_science/index.html">Research Data Science Services</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Team</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../team.html">Center for Research Computing Team</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CRC Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Software</a> &raquo;</li>
        
      <li>Singularity Overlays</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="singularity-overlays">
<h1>Singularity Overlays<a class="headerlink" href="#singularity-overlays" title="Permalink to this heading">¶</a></h1>
<p>An Overlay is a directory or a filesystem image which sits on top of a singularity container.</p>
<p>The user can make benefit of the overlays in any of the following ways:</p>
<ul class="simple">
<li><p>You have too many conda environments eating up your number of files limit</p></li>
<li><p>You have a data set consisting of a large number of small files</p></li>
<li><p>You would like to share your environments (R,conda,etc) with your collaborators with no installation required.</p></li>
</ul>
<p>This process has the following steps which are explained in more details later:</p>
<ul class="simple">
<li><p>Create an overlay of the desired size</p></li>
<li><p>Use a singularity conatiner to get into the overlay</p></li>
<li><p>Create your enviornments or copy your dataset in the <code class="docutils literal notranslate"><span class="pre">/opt</span></code> directory</p></li>
<li><p>exit the singularity container</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can think of an overlay as an external filesystem image to which you would be able to write
using singularity</p>
</div>
<div class="section" id="creating-an-overlay">
<h2>Creating an Overlay<a class="headerlink" href="#creating-an-overlay" title="Permalink to this heading">¶</a></h2>
<p>The script <code class="docutils literal notranslate"><span class="pre">overlay.sh</span></code> facilitates this process of creating an overlay based on your needs.
The command <code class="docutils literal notranslate"><span class="pre">overlay.sh</span></code> takes two arguments <code class="docutils literal notranslate"><span class="pre">size</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">overlay</span> <span class="pre">(in</span> <span class="pre">MB)</span></code> and <code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span> <span class="pre">files</span></code>
in the overlay (in 1000’s). The usage is as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#overlay.sh &lt;size&gt; &lt;num of files&gt;</span>

<span class="c1">#example:</span>
overlay.sh<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="m">700</span>
</pre></div>
</div>
<p>The above command will create an overlay with <code class="docutils literal notranslate"><span class="pre">500MB</span></code> capacity and number of files capacity <code class="docutils literal notranslate"><span class="pre">700K</span></code>
by the name <code class="docutils literal notranslate"><span class="pre">overlay-500M-700K.ext3</span></code> in the directory from which the command was issued.</p>
</div>
<div class="section" id="run-container-with-overlay-filesystem">
<h2>Run container with overlay filesystem<a class="headerlink" href="#run-container-with-overlay-filesystem" title="Permalink to this heading">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">##Please choose appropriate singularity ext3 image at this location</span>
<span class="c1">#singularity shell  --overlay &lt;chosen-file&gt;.ext3 /share/apps/admin/singularity-images/centos-8.2.2004.sif</span>

<span class="c1">#example:</span>
singularity<span class="w"> </span>shell<span class="w">  </span>--overlay<span class="w"> </span>overlay-500M-700K.ext3<span class="w"> </span>/share/apps/admin/singularity-images/centos-8.2.2004.sif
</pre></div>
</div>
<div class="admonition-analogy-to-make-things-more-understandable admonition">
<p class="admonition-title">Analogy: To make things more understandable</p>
<p>The command you use to get into the overlay is as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity<span class="w"> </span>shell<span class="w">  </span>--overlay<span class="w"> </span>&lt;chosen-file&gt;.ext3<span class="w"> </span>/share/apps/admin/singularity-images/centos-8.2.2004.sif
</pre></div>
</div>
<p>if you look closely it contains paths to two files</p>
<ul class="simple">
<li><p><strong>The Container</strong>:  <code class="docutils literal notranslate"><span class="pre">/share/apps/admin/singularity-images/centos-8.2.2004.sif</span></code></p></li>
<li><p><strong>The Overlay</strong> :  <code class="docutils literal notranslate"><span class="pre">&lt;chosen-file&gt;.ext3</span></code></p></li>
</ul>
<p>You could think of the container as your personal computer (PC) and the overlay as an external hard disk or a pendrive.</p>
<p>The thing about this conatiner PC is, that you wouldn’t be able to write any files to it but you can write files to your pendrive (the overlay). You have also plugged in your /home and /scratch and hence these are also available from inside the container pc.</p>
<p>Each of these pendrives have their own capacity (quota). You could potentially create an overlay pendrive of the capacity (quota) you like and use it store your files(data).</p>
<p>When you run the above command, you basically login to your container PC and plug in these pendrives. It looks very similar to as compared to when you log in to Jubail. You could navigate through your files in /scratch and /home as usual. For files in the overlay you can cd to the desired folder and view the files in a similar manner.</p>
<p>For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/opt/data
ls<span class="w"> </span>-lrt<span class="w"> </span>data
</pre></div>
</div>
<p>For transferring data between any of these pendrives (<code class="docutils literal notranslate"><span class="pre">/home</span></code>, <code class="docutils literal notranslate"><span class="pre">/scratch</span></code> , <code class="docutils literal notranslate"><span class="pre">overlay</span></code> etc), you could use the
usual <code class="docutils literal notranslate"><span class="pre">cp</span></code>, <code class="docutils literal notranslate"><span class="pre">mv</span></code> commands. Any files/directories created outside <code class="docutils literal notranslate"><span class="pre">/scratch</span></code>, <code class="docutils literal notranslate"><span class="pre">/home</span></code> (eg: <code class="docutils literal notranslate"><span class="pre">/data</span></code> or <code class="docutils literal notranslate"><span class="pre">/opt</span></code>)
will reside inside the overlay filesystem that can only be accessed by plugging in the overlay filesystem using the
command mentioned above.</p>
</div>
<p>If you want to mount ext3 file as read and write, you can do that only with one process.</p>
<p>If you have more than one process reading from the given ext3 file, it shall be mounted as read-only.</p>
<p>For read-only mount, please specify <code class="docutils literal notranslate"><span class="pre">:ro</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity<span class="w"> </span>shell<span class="w">  </span>--overlay<span class="w"> </span>&lt;chosen-file&gt;.ext3:ro<span class="w"> </span>/share/apps/admin/singularity-images/centos-8.2.2004.sif
</pre></div>
</div>
<p>If you use GPUs please specify option <code class="docutils literal notranslate"><span class="pre">--nv</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity<span class="w"> </span>shell<span class="w"> </span>--nv<span class="w">  </span>--overlay<span class="w"> </span>&lt;chosen-file&gt;.ext3<span class="w"> </span>/share/apps/admin/singularity-images/centos-8.2.2004.sif
</pre></div>
</div>
<p>More info on singularuty shell <a class="reference external" href="https://sylabs.io/guides/3.1/user-guide/cli/singularity_shell.html">here</a></p>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">exec</span></code> to run the container with overlay filesystem:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--overlay<span class="w"> </span>&lt;chosen-file&gt;.ext3<span class="w"> </span>/share/apps/admin/singularity-images/centos-8.2.2004.sif<span class="w"> </span>/bin/bash
</pre></div>
</div>
<p>More info on singularity exec <a class="reference external" href="https://sylabs.io/guides/3.5/user-guide/cli/singularity_exec.html">here</a></p>
</div>
<div class="section" id="write-to-overlay-filesystem">
<h2>Write to overlay filesystem<a class="headerlink" href="#write-to-overlay-filesystem" title="Permalink to this heading">¶</a></h2>
<p>You can write to the directory <code class="docutils literal notranslate"><span class="pre">/opt</span></code> to create conda environment and install packages that you need.All the environments and datasets written from inside the container
to <code class="docutils literal notranslate"><span class="pre">opt</span></code> are actually witten into the overlay which has been created.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It should be noted that you can write to any of the directories and create your own directories in
the overlay as well:</p>
<p>for example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>/data
mkdir<span class="w"> </span>-p<span class="w"> </span>/conda
</pre></div>
</div>
<p>The above commands will create <code class="docutils literal notranslate"><span class="pre">/data</span></code> and <code class="docutils literal notranslate"><span class="pre">/conda</span></code> directories, which will be part of the overlay itself.
In Short, anything written inside the overlay except in <code class="docutils literal notranslate"><span class="pre">/scratch</span></code> and <code class="docutils literal notranslate"><span class="pre">/home</span></code> will go inside the overlay
and the files/directories written in <code class="docutils literal notranslate"><span class="pre">/scratch</span></code> and <code class="docutils literal notranslate"><span class="pre">/home</span></code>, will stay there and wouldn’t be part of the
overlay.</p>
</div>
</div>
<div class="section" id="while-in-container">
<h2>While in container<a class="headerlink" href="#while-in-container" title="Permalink to this heading">¶</a></h2>
<p><strong>Creating a Conda Environment</strong></p>
<p>You can create a conda environment in /opt as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>miniconda
<span class="nb">source</span><span class="w"> </span>~/.bashrc

<span class="c1">#Create new environments in /opt</span>
conda<span class="w"> </span>create<span class="w"> </span>-p<span class="w"> </span>/opt/conda-envs/myenv

conda<span class="w"> </span>activate<span class="w"> </span>/opt/conda-envs/myenv
<span class="c1">## then use conda as usual</span>

<span class="c1">#Close singularity</span>
<span class="nb">exit</span>
</pre></div>
</div>
<p><strong>Transferring Datasets</strong></p>
<p>You can also copy the Dataset from your local folder and place it under <code class="docutils literal notranslate"><span class="pre">/opt</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#Example:</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/data
cp<span class="w"> </span>-r<span class="w"> </span>/scratch/wz22/dataset.zip<span class="w"> </span>/opt/data/.
unzip<span class="w"> </span>dataset.zip
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to copy the datasets to the overlay in compressed formats (zip or tar) and then extract it
in the overlay.</p>
</div>
</div>
<div class="section" id="sharing-the-overlay">
<h2>Sharing the Overlay<a class="headerlink" href="#sharing-the-overlay" title="Permalink to this heading">¶</a></h2>
<p>The overlay can also be shared with your collaborators. All the environments and datasets written from inside the container
to <code class="docutils literal notranslate"><span class="pre">opt</span></code> are actually witten into the overlay which has been created. Hence, the sharing of an overlay with a
collaborator is equivalent to sharing the working environment with the datasets, also it means essentially sharing whatever
is written into the overlay directory <code class="docutils literal notranslate"><span class="pre">/opt</span></code>.</p>
</div>
<div class="section" id="job-submission">
<h2>Job Submission<a class="headerlink" href="#job-submission" title="Permalink to this heading">¶</a></h2>
<p>A sample job script can look as follows.</p>
<p>Note that all the commands to be executed within the container are part of the <code class="docutils literal notranslate"><span class="pre">/bin/bash</span> <span class="pre">-c</span> <span class="pre">&quot;&lt;commands</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">executed&gt;&quot;</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --mem=8GB</span>
<span class="c1">#SBATCH --time=1:00:00</span>

<span class="c1">#Specify location of the overlay.ext3 file</span>
<span class="nv">overlay_ext3</span><span class="o">=</span>/scratch/wz22/overlay-500M-700K.ext3

singularity<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nb">exec</span><span class="w"> </span>--nv<span class="w"> </span>--overlay<span class="w"> </span><span class="nv">$overlay_ext3</span>:ro<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>/share/apps/admin/singularity-images/centos-8.2.2004.sif<span class="w">  </span><span class="se">\</span>
<span class="w">    </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;source ~/.bashrc; \</span>
<span class="s2">                conda activate /opt/conda-envs/myenv; \</span>
<span class="s2">                python &lt;path_to_python_script_file&gt;.py &quot;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="r_hpc_miniconda.html" class="btn btn-neutral float-right" title="R in HPC Miniconda" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="singularity_commands.html" class="btn btn-neutral float-left" title="Singularity - How to Run on HPC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, Center for Research Computing | NYU Abu Dhabi.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>